{% extends 'dashboard/base.html' %}
{% load i18n %}
{% load humanize %}

{% block title %}Управление продуктами - Панель управления{% endblock %}
{% block page_title %}Управление продуктами{% endblock %}

{% block content %}
<!-- Фильтры -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-4">
                <input type="text" class="form-control" name="search"
                       placeholder="Поиск по названию продукта или SKU..." value="{{ search_query }}">
            </div>
            <div class="col-md-3">
                <select class="form-control" name="category">
                    <option value="">Все категории</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" {% if category_filter == category.id|stringformat:"s" %}selected{% endif %}>
                        {{ category.name_uz|default:category.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-control" name="status">
                    <option value="">Все статусы</option>
                    <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Активный</option>
                    <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Неактивный</option>
                    <option value="featured" {% if status_filter == 'featured' %}selected{% endif %}>Рекомендуемый</option>
                    <option value="out_of_stock" {% if status_filter == 'out_of_stock' %}selected{% endif %}>Нет в наличии</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-search"></i> Фильтр
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Таблица продуктов -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Продукты ({{ page_obj.paginator.count }})</h5>
        <a href="{% url 'dashboard:product_create' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Добавить продукт
        </a>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Изображение</th>
                        <th>Название</th>
                        <th>SKU</th>
                        <th>Категория</th>
                        <th>Цена</th>
                        <th>Запас</th>
                        <th>Статус</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in page_obj %}
                    <tr>
                        <td>
                            {% if product.main_image %}
                                <img src="{{ product.main_image.url }}" alt="{{ product.name_uz|default:product.name }}"
                                     class="rounded" style="width: 50px; height: 50px; object-fit: cover;">
                            {% else %}
                                <div class="bg-light rounded d-flex align-items-center justify-content-center"
                                     style="width: 50px; height: 50px;">
                                    <i class="fas fa-image text-muted"></i>
                                </div>
                            {% endif %}
                        </td>
                        <td>
                            <div class="fw-semibold">
                                {{ product.name_uz|default:product.name_en|default:product.name_ru|default:"Без названия"|truncatechars:40 }}
                            </div>
                            {% if product.name_en or product.name_ru %}
                                <small class="text-muted">
                                    {% if product.name_en and product.name_en != product.name_uz %}
                                        {{ product.name_en|truncatechars:30 }}
                                    {% endif %}
                                    {% if product.name_en and product.name_ru and product.name_en != product.name_uz and product.name_ru != product.name_uz %} | {% endif %}
                                    {% if product.name_ru and product.name_ru != product.name_uz %}
                                        {{ product.name_ru|truncatechars:30 }}
                                    {% endif %}
                                </small>
                            {% endif %}
                            {% if product.youtube_video_id %}
                                <br><small class="text-info">
                                    <i class="fab fa-youtube"></i> Есть видео
                                </small>
                            {% endif %}
                        </td>
                        <td>
                            <code>{{ product.sku }}</code>
                        </td>
                        <td>
                            {{ product.category.name_uz|default:product.category.name }}
                        </td>
                        <td>
                            <div class="fw-semibold">${{ product.price_usd|floatformat:0|intcomma }}</div>
                            <small class="text-muted">{{ product.price_uzs|floatformat:0|intcomma }} UZS</small>
                        </td>
                        <td>
                            {% if product.stock_quantity > 0 %}
                                <span class="badge bg-success">{{ product.stock_quantity|intcomma }}</span>
                            {% else %}
                                <span class="badge bg-danger">Нет в наличии</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="form-check form-switch">
                                <input class="form-check-input toggle-status" type="checkbox"
                                       data-product-id="{{ product.id }}"
                                       {% if product.is_active %}checked{% endif %}>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex gap-1">
                                <a href="{{ product.get_absolute_url }}" class="btn btn-sm btn-outline-primary"
                                   target="_blank" title="Просмотр">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{% url 'dashboard:product_edit' product.id %}"
                                   class="btn btn-sm btn-outline-secondary" title="Редактировать">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-danger"
                                        onclick="deleteProduct({{ product.id }}, '{{ product.name_uz|default:product.name_en|default:product.name_ru }}')"
                                        title="Удалить">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="fas fa-box fa-2x mb-2"></i>
                            <div>Продукты не найдены</div>
                            <small>Добавьте новый продукт, используя кнопку выше</small>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Пагинация -->
        {% if page_obj.has_other_pages %}
        <nav aria-label="Пагинация" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">{{ num }}</a>
                </li>
                {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- Модальное окно подтверждения удаления -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Удаление продукта</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body">
                <p>Вы уверены, что хотите удалить продукт <strong id="productName"></strong>?</p>
                <p class="text-danger small">
                    <i class="fas fa-exclamation-triangle"></i>
                    Это действие нельзя отменить, и все связанные данные будут удалены.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Удалить</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let deleteProductId = null;

// Переключение статуса продукта
document.querySelectorAll('.toggle-status').forEach(function(toggle) {
    toggle.addEventListener('change', function() {
        const productId = this.dataset.productId;
        const isActive = this.checked;
        const toggleElement = this;

        // Показать состояние загрузки
        toggleElement.disabled = true;

        fetch('{% url "dashboard:ajax_toggle_product_status" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: 'product_id=' + productId + '&is_active=' + isActive
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Ошибка сети: ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Обновить состояние переключателя на основе ответа сервера
                toggleElement.checked = data.is_active;
                showAlert('Статус продукта успешно обновлен!', 'success');
            } else {
                // Вернуться к предыдущему состоянию при ошибке
                toggleElement.checked = !isActive;
                showAlert('Ошибка обновления статуса продукта: ' + (data.message || 'Неизвестная ошибка'), 'danger');
            }
        })
        .catch(error => {
            console.error('Ошибка:', error); // Записать ошибку для отладки
            // Вернуться к предыдущему состоянию при ошибке
            toggleElement.checked = !isActive;
            showAlert('Ошибка обновления статуса продукта: ' + error.message, 'danger');
        })
        .finally(() => {
            toggleElement.disabled = false;
        });
    });
});

// Функция удаления продукта
function deleteProduct(productId, productName) {
    deleteProductId = productId;
    document.getElementById('productName').textContent = productName;

    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

// Нажатие кнопки подтверждения удаления
document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
    if (deleteProductId) {
        $.ajax({
            url: '{% url "dashboard:product_delete" 0 %}'.replace('0', deleteProductId),
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    showAlert('Продукт успешно удален!', 'success');
                    // Перезагрузить страницу после небольшой задержки
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showAlert(response.message || 'Произошла ошибка', 'danger');
                }

                // Скрыть модальное окно
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                modal.hide();
            },
            error: function() {
                showAlert('Ошибка подключения к серверу', 'danger');

                // Скрыть модальное окно
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                modal.hide();
            }
        });
    }
});

// Функция показа уведомления
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    const contentArea = document.querySelector('.card-body');
    contentArea.insertBefore(alertDiv, contentArea.firstChild);

    // Автоматическое закрытие через 5 секунд
    setTimeout(() => {
        const bsAlert = new bootstrap.Alert(alertDiv);
        bsAlert.close();
    }, 5000);
}

// Улучшение формы поиска
document.querySelector('input[name="search"]').addEventListener('keyup', function(e) {
    if (e.key === 'Enter') {
        e.target.closest('form').submit();
    }
});
</script>
{% endblock %}