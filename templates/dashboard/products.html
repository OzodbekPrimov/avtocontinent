{% extends 'dashboard/base.html' %}
{% load i18n %}
{% load humanize %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏ - –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è{% endblock %}
{% block page_title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏{% endblock %}

{% block content %}
<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-4">
                <input type="text" class="form-control" name="search"
                       placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –ø—Ä–æ–¥—É–∫—Ç–∞ –∏–ª–∏ SKU..." value="{{ search_query }}">
            </div>
            <div class="col-md-3">
                <select class="form-control" name="category">
                    <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" {% if category_filter == category.id|stringformat:"s" %}selected{% endif %}>
                        {{ category.name_uz|default:category.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-control" name="status">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="active" {% if status_filter == 'active' %}selected{% endif %}>–ê–∫—Ç–∏–≤–Ω—ã–π</option>
                    <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π</option>
                    <option value="featured" {% if status_filter == 'featured' %}selected{% endif %}>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π</option>
                    <option value="out_of_stock" {% if status_filter == 'out_of_stock' %}selected{% endif %}>–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-search"></i> –§–∏–ª—å—Ç—Ä
                </button>
            </div>
        </form>

        <!-- –ë—ã—Å—Ç—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –∫–æ—Ä–∑–∏–Ω–∞–º -->
        <div class="mt-3 d-flex gap-2 flex-wrap">
            <a href="?search={{ search_query }}&category={{ category_filter }}&status={{ status_filter }}&cart_filter=critical"
               class="btn btn-sm {% if cart_filter == 'critical' %}btn-danger{% else %}btn-outline-danger{% endif %}">
                ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–Ω–æ
            </a>
            <a href="?search={{ search_query }}&category={{ category_filter }}&status={{ status_filter }}&cart_filter=popular"
               class="btn btn-sm {% if cart_filter == 'popular' %}btn-warning{% else %}btn-outline-warning{% endif %}">
                üî• –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ
            </a>
            <a href="?search={{ search_query }}&category={{ category_filter }}&status={{ status_filter }}&cart_filter=zero"
               class="btn btn-sm {% if cart_filter == 'zero' %}btn-secondary{% else %}btn-outline-secondary{% endif %}">
                üò¥ –ù–æ–ª—å
            </a>
            <a href="{% url 'dashboard:products' %}" class="btn btn-sm btn-outline-dark">
                –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
            </a>
        </div>
    </div>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">–ü—Ä–æ–¥—É–∫—Ç—ã ({{ page_obj.paginator.count }})</h5>
        <a href="{% url 'dashboard:product_create' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç
        </a>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</th>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>SKU</th>
                        <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                        <th>–¶–µ–Ω–∞</th>
                        <th>–ó–∞–ø–∞—Å</th>
                        <th>üõí –í –∫–æ—Ä–∑–∏–Ω–∞—Ö</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in page_obj %}
                    <tr>
                        <td>
                            {% if product.main_image %}
                                <img src="{{ product.main_image.url }}" alt="{{ product.name_uz|default:product.name }}"
                                     class="rounded" style="width: 50px; height: 50px; object-fit: cover;">
                            {% else %}
                                <div class="bg-light rounded d-flex align-items-center justify-content-center"
                                     style="width: 50px; height: 50px;">
                                    <i class="fas fa-image text-muted"></i>
                                </div>
                            {% endif %}
                        </td>
                        <td>
                            <div class="fw-semibold">
                                {{ product.name_uz|default:product.name_uz_Cyrl|default:product.name_ru|default:"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"|truncatechars:40 }}
                            </div>
                            {% if product.name_uz_Cyrl or product.name_ru %}
                                <small class="text-muted">
                                    {% if product.name_uz_Cyrl and product.name_uz_Cyrl != product.name_uz %}
                                        {{ product.name_uz_Cyrl|truncatechars:30 }}
                                    {% endif %}
                                    {% if product.name_uz_Cyrl and product.name_ru and product.name_uz_Cyrl != product.name_uz and product.name_ru != product.name_uz %} | {% endif %}
                                    {% if product.name_ru and product.name_ru != product.name_uz %}
                                        {{ product.name_ru|truncatechars:30 }}
                                    {% endif %}
                                </small>
                            {% endif %}
                            {% if product.youtube_video_id %}
                                <br><small class="text-info">
                                    <i class="fab fa-youtube"></i> –ï—Å—Ç—å –≤–∏–¥–µ–æ
                                </small>
                            {% endif %}
                        </td>
                        <td>
                            <code>{{ product.sku }}</code>
                        </td>
                        <td>
                            {{ product.category.name_uz|default:product.category.name }}
                        </td>
                        <td>
                            <div class="fw-semibold">${{ product.price_usd|floatformat:0|intcomma }}</div>
                            <small class="text-muted">{{ product.price_uzs|floatformat:0|intcomma }} UZS</small>
                        </td>
                        <td>
                            {% if product.stock_quantity > 0 %}
                                <span class="badge bg-success">{{ product.stock_quantity|intcomma }}</span>
                            {% else %}
                                <span class="badge bg-danger">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>
                            {% endif %}
                        </td>
                        <td>
                            {% with count=product.cart_count|default:0 %}
                                {% if count > 0 %}
                                    <span class="me-1">{{ count }} —á–µ–ª–æ–≤–µ–∫</span>
                                {% else %}
                                    <span class="me-1">0</span>
                                {% endif %}
                                {% if count > 0 and product.stock_quantity < count %}
                                    <span class="text-danger" title="–ó–∞–ø–∞—Å –º–µ–Ω—å—à–µ, —á–µ–º –ª—é–¥–µ–π —Å —Ç–æ–≤–∞—Ä–æ–º –≤ –∫–æ—Ä–∑–∏–Ω–µ">‚ö†Ô∏è</span>
                                {% endif %}
                            {% endwith %}
                        </td>
                        <td>
                            <div class="form-check form-switch">
                                <input class="form-check-input toggle-status" type="checkbox"
                                       data-product-id="{{ product.id }}"
                                       {% if product.is_active %}checked{% endif %}>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex gap-1">
                                <a href="{{ product.get_absolute_url }}" class="btn btn-sm btn-outline-primary"
                                   target="_blank" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{% url 'dashboard:product_edit' product.id %}"
                                   class="btn btn-sm btn-outline-secondary" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-danger"
                                        onclick="deleteProduct({{ product.id }}, '{{ product.name_uz|default:product.name_uz_Cyrl|default:product.name_ru }}')"
                                        title="–£–¥–∞–ª–∏—Ç—å">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="text-center text-muted py-4">
                            <i class="fas fa-box fa-2x mb-2"></i>
                            <div>–ù–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤</div>
                            <small>–î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç, –∏—Å–ø–æ–ª—å–∑—É—è –∫–Ω–æ–ø–∫—É –≤—ã—à–µ</small>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        {% if page_obj.has_other_pages %}
        <nav aria-label="–ü–∞–≥–∏–Ω–∞—Ü–∏—è" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">{{ num }}</a>
                </li>
                {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">–£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
            </div>
            <div class="modal-body">
                <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç <strong id="productName"></strong>?</p>
                <p class="text-danger small">
                    <i class="fas fa-exclamation-triangle"></i>
                    –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å, –∏ –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let deleteProductId = null;

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–¥—É–∫—Ç–∞
document.querySelectorAll('.toggle-status').forEach(function(toggle) {
    toggle.addEventListener('change', function() {
        const productId = this.dataset.productId;
        const isActive = this.checked;
        const toggleElement = this;

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
        toggleElement.disabled = true;

        fetch('{% url "dashboard:ajax_toggle_product_status" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: 'product_id=' + productId + '&is_active=' + isActive
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
                toggleElement.checked = data.is_active;
                showAlert('–°—Ç–∞—Ç—É—Å –ø—Ä–æ–¥—É–∫—Ç–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
            } else {
                // –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é –ø—Ä–∏ –æ—à–∏–±–∫–µ
                toggleElement.checked = !isActive;
                showAlert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–¥—É–∫—Ç–∞: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'danger');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error); // –ó–∞–ø–∏—Å–∞—Ç—å –æ—à–∏–±–∫—É –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            // –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é –ø—Ä–∏ –æ—à–∏–±–∫–µ
            toggleElement.checked = !isActive;
            showAlert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–¥—É–∫—Ç–∞: ' + error.message, 'danger');
        })
        .finally(() => {
            toggleElement.disabled = false;
        });
    });
});

// –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞
function deleteProduct(productId, productName) {
    deleteProductId = productId;
    document.getElementById('productName').textContent = productName;

    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

// –ù–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è
document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
    if (deleteProductId) {
        $.ajax({
            url: '{% url "dashboard:product_delete" 0 %}'.replace('0', deleteProductId),
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    showAlert('–ü—Ä–æ–¥—É–∫—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!', 'success');
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showAlert(response.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'danger');
                }

                // –°–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                modal.hide();
            },
            error: function() {
                showAlert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'danger');

                // –°–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                modal.hide();
            }
        });
    }
});

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    const contentArea = document.querySelector('.card-body');
    contentArea.insertBefore(alertDiv, contentArea.firstChild);

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        const bsAlert = new bootstrap.Alert(alertDiv);
        bsAlert.close();
    }, 5000);
}

// –£–ª—É—á—à–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –ø–æ–∏—Å–∫–∞
document.querySelector('input[name="search"]').addEventListener('keyup', function(e) {
    if (e.key === 'Enter') {
        e.target.closest('form').submit();
    }
});
</script>
{% endblock %}